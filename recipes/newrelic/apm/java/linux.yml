# Visit our schema definition for additional information on this file format
# https://github.com/newrelic/open-install-library/blob/main/docs/recipe-spec/recipe-spec.md#schema-definition

name: java-agent-installer
displayName: Java Agent Installer
description: New Relic install recipe for instrumenting Java applications
repository: https://github.com/newrelic/newrelic-java-agent

installTargets:
  - type: application
    os: linux
    kernelArch: x86_64
    platformFamily: "rhel"
  - type: application
    os: linux
    kernelArch: x86_64
    platformFamily: "debian"

dependencies:
  - infrastructure-agent-installer

keywords:
  - Apm
  - java

logMatch:
  - name: tomcat-versioned-catalina
    file: /opt/tomcat/*tomcat*/logs/*.log

processMatch:
  - java.*org.apache.catalina.startup.Bootstrap

preInstall:
  requireAtDiscovery: |
    user=$(whoami)
    if [[ "$user" != "root" ]]; then
      echo -e "This script must be run as root." >&2
      exit 132
    fi

    cutInstalled=$(which cut 2> /dev/null)
    if [[ -z "$cutInstalled" ]]; then
      echo -e "This installation recipe for the New Relic Java Agent on Linux requires 'cut' to be installed." >&2
      exit 132
    fi

    # Map of tool names to the associated error code
    required_tools_and_error_codes="grep:132 cat:132 tee:132"
    for tuple in $required_tools_and_error_codes; do
      tool=$(echo ${tuple} |cut -d':' -f1)
      code=$(echo ${tuple} |cut -d':' -f2)
      toolInstalled=$(which ${tool} | wc -l)
      if [[ "$toolInstalled" -eq 0 ]]; then
        echo -e "This installation recipe for the New Relic Java Agent on Linux requires '${tool}' to be installed." >&2
        exit ${code}
      fi
    done

    exit 0

validationNrql: "SELECT count(*) from Transaction WHERE host like '{{.HOSTNAME}}%' facet entityGuid since 10 minutes ago"

successLinkConfig:
  type: EXPLORER
  filter: '"`tags.language` = ''java''"'

install:

  version: "3"
  silent: true

  tasks:
    default:
      cmds:
        - task: verify-continue
        - task: init
        - task: get-introspector
        - task: install-instrument-script
        - task: add-on-host-integration

    verify-continue:
      cmds:
        - |
          YELLOW='\033[0;33m'
          NOCOLOR='\033[0m'
          echo -e "${YELLOW}
          ===============================================================================================
          =                                                                                             =
          =                                           Warning                                           =
          =                                                                                             =
          =         This installation will periodically check for new Tomcat processes to monitor.      =
          =                                                                                             =
          =                                                                                             =
          ===============================================================================================
          ${NOCOLOR}"
          echo "
          If you prefer to instrument your Java application differently then check out our other installation options:
          https://docs.newrelic.com/docs/agents/java-agent/installation/install-java-agent/.
          "
          if [[ "{{.NEW_RELIC_ASSUME_YES}}" != "true" ]]; then
            while :; do
              echo -n "Do you want to install the Java Agent Y/N (default: Y)? "
              read answer
              echo ""
              if [[ -z "$answer" ]]; then
                exit 0
              fi
              firstChar=$(echo "${answer^^}" | cut -c1-1)
              if [[ "$firstChar" == "N" ]]; then
                echo "Exiting the installation"
                exit 130
              fi
              if [[ "$firstChar" == "Y" ]]; then
                exit 0
              fi
              echo -e "Please type Y or N only."
            done
          fi

    init:
      cmds:
        - |
          if [ ! -f /etc/newrelic-java ]; then
            mkdir -p /etc/newrelic-java
          fi

    get-introspector:
      cmds:
        - |
          echo "Retrieving Java Introspector..."
          isYumInstalled=$(which yum 2>&1 || true)
          if [[ -n "$isYumInstalled" ]]; then
            curl -s -O https://download.newrelic.com/install/java/introspector/latest/nri-introspector-java-0.1.0_SNAPSHOT-2.x86_64.rpm
            yum install -y -q nri-introspector-java-0.1.0_SNAPSHOT-2.x86_64.rpm 2> /dev/null || true
          else
            curl -s -O https://download.newrelic.com/install/java/introspector/latest/nri-introspector-java_0.1.0_SNAPSHOT-2_amd64.deb
            apt-get install -y -qq ./nri-introspector-java_0.1.0_SNAPSHOT-2_amd64.deb 2> /dev/null || true
          fi
          while :; do
            isJavaLsiRunning=$(sudo ps aux | grep nri-lsi-java | grep -v grep | wc -l)
            if [ "$isJavaLsiRunning" -eq 0 ]
            then
              break
            else
              sleep 1
            fi
          done

    install-instrument-script:
      cmds:
        - |
          if [ -f /etc/newrelic-java/dynamic-attach.sh ]; then
            rm -f /etc/newrelic-java/dynamic-attach.sh
          fi

          rm -rf /etc/newrelic-java/.pids
          mkdir -p /etc/newrelic-java/.pids
          touch /etc/newrelic-java/.pids/saved_pids
          chmod -R 700 /etc/newrelic-java/.pids

          tee -a /etc/newrelic-java/dynamic-attach.sh > /dev/null <<"EOT"
          #!/bin/bash
          build_stdout_json() {
            message=$1
            cat << EOF
            {
               "name": "java-dynamic-attach",
               "protocol_version": "1",
               "integration_version": "1.0.0",
               "metrics": [
                 {
                   "event_type": "JavaDynamicAttachSample",
                   "provider": "com.newrelic.virtuoso",
                   "provider.executableName": "$message"
                 }
               ]
            }
          EOF
          }

          license={{.NEW_RELIC_LICENSE_KEY}}
          region={{.NEW_RELIC_REGION}}
          appName='{{.HOSTNAME}}-nr-app'
          pattern='org.apache.catalina.startup.Bootstrap'

          # gives list of all PIDS
          echo $(build_stdout_json "touching detected_pids")
          touch .pids/detected_pids
          echo $(build_stdout_json "writing detected_pids")
          sudo nri-lsi-java -list | tr -d '[]' | xargs >> .pids/detected_pids

          # finds dead processes
          echo $(build_stdout_json "touching dead_pids")
          touch .pids/dead_pids
          echo $(build_stdout_json "finding dead_pids")
          comm -13 .pids/detected_pids .pids/saved_pids >> .pids/dead_pids

          # finds new processes
          echo $(build_stdout_json "touching new_pids")
          touch .pids/new_pids
          echo $(build_stdout_json "finding new_pids")
          comm -23 .pids/detected_pids .pids/saved_pids >> .pids/new_pids

          echo $(build_stdout_json "removing detected_pids")
          rm .pids/detected_pids

          # instrument new PIDs
          echo $(build_stdout_json "iterating over new_pids")
          for JAVA_PID in $(cat .pids/new_pids);
          do
            INTROSPECTION_DATA=$(sudo nri-lsi-java -introspect ${JAVA_PID})
            isMatchingPattern=$(echo $INTROSPECTION_DATA | grep $pattern | grep -v grep | wc -l)
            if [ "$isMatchingPattern" -gt 0 ]; then
              echo $(build_stdout_json "attaching new process ${JAVA_PID}")
              output=$(sudo nri-lsi-java -apm $JAVA_PID -appName $appName -license $license -region $region)
              echo $(build_stdout_json "saving ${JAVA_PID}")
              echo $JAVA_PID >> .pids/saved_pids
            else
              echo $(build_stdout_json "${JAVA_PID} did not match pattern ${pattern}")
            fi
          done

          # remove dead PIDs
          echo $(build_stdout_json "removing dead_pids")
          for DEAD_PID in $(cat .pids/dead_pids);
          do
            cat .pids/$saved_pids | tr -d $DEAD_PID
          done

          # cleanup temp files, return empty json
          echo $(build_stdout_json "removing temp_files")
          rm .pids/dead_pids
          rm .pids/new_pids
          echo {}
          EOT
          sudo chmod 700 /etc/newrelic-java/dynamic-attach.sh

    add-on-host-integration:
      cmds:
        - |
          if [ -f /etc/newrelic-infra/integrations.d/java-dynamic-attach-config.yml ]; then
            rm -f /etc/newrelic-infra/integrations.d/java-dynamic-attach-config.yml
          fi
          tee -a /etc/newrelic-infra/integrations.d/java-dynamic-attach-config.yml > /dev/null <<"EOT"
          integrations:
            - name: java-dynamic-attach
              exec: /etc/newrelic-java/dynamic-attach.sh
              interval: 60s
              integration_user: root

          EOT
          sudo chmod 700 /etc/newrelic-infra/integrations.d/java-dynamic-attach-config.yml