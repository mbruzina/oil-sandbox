---
- debug:
    msg: Install NGINX reverse proxy

- name: Set default open_status_url (default not open)
  set_fact:
    open_status_url: "false"
  when: open_status_url is undefined

- name: Set default create_env_var (default not create)
  set_fact:
    create_env_var: "false"
  when: create_env_var is undefined

- name: Set default inaccessible_status_stub (default false)
  set_fact:
    inaccessible_status_stub: "false"
  when: inaccessible_status_stub is undefined

- name: Get latest packages info
  shell: "apt update"
  become: true

- name: Install nginx
  shell: "apt install nginx -y"
  become: true

- block:
  - name: Configure nginx default route with status module
    blockinfile:
      path: /etc/nginx/sites-enabled/default
      insertafter: "^server {"
      marker: "# {mark} Enable status for default route"
      block: |
          location = /status {
              stub_status;
          }
    become: yes
  when: open_status_url|bool

- block:
  - name: Export NR_CLI_STUB_STATUS_URL
    shell: "echo export NR_CLI_STUB_STATUS_URL=http://127.0.0.1/status >> ~/.bashrc"
  when: create_env_var|bool

- block:
  - name: Configure nginx status stub to location not accessible via localhost
    blockinfile:
      path: /etc/nginx/sites-enabled/default
      insertafter: "^server {"
      marker: "# {mark} Deny access to status stub, even for localhost"
      block: |
          location = /status {
              stub_status;
              deny all;
          }
    become: yes
  when: inaccessible_status_stub|bool

- name: Restart nginx
  shell: "systemctl restart nginx"
  become: yes
