---

- name: purge python-pip
  shell: apt-get purge --auto-remove python-pip
  become: yes

- name: apt-get update
  shell: apt-get update
  become: yes
  ignore_errors: true

- name: install pip
  shell: apt-get -y install python3-pip
  become: yes

- name: install docker-py
  shell: pip install docker-py
  become: yes

- name: install boto3
  shell: pip install boto3
  become: yes

#- name: Download war from s3
#  aws_s3:
#    aws_access_key: "{{ AWS_ACCESS_KEY_ID }}"
#    aws_secret_key: "{{ AWS_SECRET_ACCESS_KEY }}"
#    bucket: open-install-library-artifacts
#    object: linux/java/spring-boot-rest.war
#    s3_url: s3://open-install-library-artifacts/linux/java/
#    dest: "files/ROOT.war"
#    mode: get


- name: Upload war to host
  synchronize: src=. dest=/home/{{ ansible_user }}
  become: yes

- name: Build Tomcat Image
  docker_image: >
    name=spring-boot-rest
    tag=1
    path=/home/{{ ansible_user }}
    state=present
  become: yes

- name: Run Tomcat Docker container
  shell: "docker run -d -p {{ service_port }}:8080 --env TOMCAT_USERNAME=tomcat --env TOMCAT_PASSWORD=tomcat --name tomcat-hello-api tomcat:hello-api"
  become: yes